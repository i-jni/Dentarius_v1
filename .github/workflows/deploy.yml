name: ğŸš€ Deploy Dentarius to Production
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸ”¥ Deploy to Server
    runs-on: ubuntu-latest
    steps:
    - name: ğŸš€ Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "ğŸ”„ Starting deployment..."
          # Navigate to project
          cd /var/www/Dentarius_v1
          
          # Get current commit hash
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "ğŸ“ Current commit: $CURRENT_COMMIT"
          
          # Force reset to match GitHub
          echo "ğŸ”„ Resetting to latest GitHub version..."
          git fetch origin
          git reset --hard origin/main
          
          # Get new commit hash
          NEW_COMMIT=$(git rev-parse HEAD)
          echo "ğŸ“ New commit: $NEW_COMMIT"
          
          # Check if backend changed
          BACKEND_CHANGED=$(git diff --name-only $CURRENT_COMMIT $NEW_COMMIT | grep -E '^backend/' || echo "")
          
          if [ -n "$BACKEND_CHANGED" ]; then
            echo "ğŸ”§ Backend files changed - Updating backend..."
            cd backend
            export $(cat .env.production | xargs)
            npm install --omit=dev
            pm2 restart dentarius-backend
            cd ..
          else
            echo "â­ï¸ Backend unchanged - Skipping backend deployment"
          fi
          
          # Check if frontend changed
          FRONTEND_CHANGED=$(git diff --name-only $CURRENT_COMMIT $NEW_COMMIT | grep -E '^frontend/' || echo "")
          
          if [ -n "$FRONTEND_CHANGED" ]; then
            echo "ğŸ¨ Frontend files changed - Building frontend..."
            cd frontend
            # Clean install
            echo "ğŸ§¹ Cleaning..."
            rm -rf node_modules package-lock.json
            echo "ğŸ“¦ Installing ALL dependencies (including dev)..."
            NODE_ENV=development npm install
            echo "ğŸ” Verifying Vite installation..."
            npm list vite
            ls -la node_modules/.bin/vite
            echo "ğŸ—ï¸ Building with Vite..."
            VITE_API_URL=https://dentarius.org/api npm run build
            echo "â™»ï¸ Restarting nginx..."
            sudo systemctl reload nginx
          else
            echo "â­ï¸ Frontend unchanged - Skipping frontend build"
          fi
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Site available at: https://dentarius.org"